#!/bin/bash

# This script is to be run in a TravisCI context.
set -ex

if [ -n "$GH_TOKEN" ]; then
    source activate base

    make clean
    ablog build

    ls -lah _website

    if [[ "$TRAVIS_BRANCH" == "master" ]] && [[ "$TRAVIS_PULL_REQUEST" == "false" ]]; then
        git clone https://github.com/conda-forge/blog.git blog_repo
        pushd blog_repo
        git checkout gh-pages
        git rm -r .
        git commit --allow-empty -am '[ci skip] removed old site'
        cp -r ../_website/* .
        touch .nojekyll
        git add -A :/
        git commit --allow-empty -am "[ci skip] ran ablog build"
        git remote add pushable https://${GH_TOKEN}@github.com/conda-forge/blog.git/ > /dev/null

        # Update the remotes before pushing and check the status.
        # This should give us more info if the push will not be
        # a simple fast-forward push.
        git fetch --all 2> /dev/null
        git branch -u pushable/gh-pages
        git status
        git push pushable gh-pages:gh-pages 2> /dev/null
        popd
    fi
fi
